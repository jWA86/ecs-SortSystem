{"version":3,"sources":["../src/bundler/dependency-walker.ts"],"names":[],"mappings":"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","file":"../../../../../../../../dist/bundler/dependency-walker.js","sourcesContent":["import * as async from \"async\";\nimport * as diff from \"diff\";\nimport * as fs from \"fs\";\nimport * as glob from \"glob\";\nimport * as lodash from \"lodash\";\nimport * as os from \"os\";\nimport * as path from \"path\";\nimport * as ts from \"typescript\";\n\nimport { Logger } from \"log4js\";\n\nimport pad = require(\"pad\");\n\nimport { EmitOutput } from \"../compiler/emit-output\";\nimport { BundleItem } from \"./bundle-item\";\nimport { Queued } from \"./queued\";\n\nexport class DependencyWalker {\n\n    private requireRegexp = /\\brequire\\b/;\n    private walk = require(\"acorn/dist/walk\");\n\n    constructor(private log: Logger) {}\n\n    public hasRequire(s: string): boolean {\n        return this.requireRegexp.test(s);\n    }\n\n    public collectTypescriptDependencies(queue: Queued[]): number {\n\n        let dependencyCount: number = 0;\n        let ambientModuleNames = this.collectAmbientModules(queue);\n\n        queue.forEach((queued) => {\n\n            queued.item.dependencies = this.findUnresolvedTsRequires(queued.emitOutput);\n\n            let resolvedModules = (<any> queued.emitOutput.sourceFile).resolvedModules;\n\n            if (resolvedModules && !queued.emitOutput.isDeclarationFile) {\n\n                if (lodash.isMap(resolvedModules)) { // Typescript 2.2+\n                    resolvedModules.forEach((resolvedModule: any, moduleName: string) => {\n                        this.addBundleItem(queued, resolvedModule, moduleName, ambientModuleNames);\n                    });\n                }\n                else { // Typescript 1.6.2 - 2.1.6\n                    Object.keys(resolvedModules).forEach((moduleName: string) => {\n                        let resolvedModule = resolvedModules[moduleName];\n                        this.addBundleItem(queued, resolvedModule, moduleName, ambientModuleNames);\n                    });\n                }\n            }\n\n            dependencyCount += queued.item.dependencies.length;\n        });\n\n        this.validateCase(queue);\n\n        return dependencyCount;\n    }\n\n    public collectJavascriptDependencies(bundleItem: BundleItem,\n                                         onDependenciesCollected: { (moduleNames: string[]): void }): void {\n\n        let moduleNames: string[] = [];\n        let expressions: any[] = [];\n\n        let isRequire = (node: any) => {\n            return node.type === \"CallExpression\" &&\n                   node.callee.type === \"Identifier\" &&\n                   node.callee.name === \"require\";\n        };\n\n        let visitNode = (node: any, state: any, c: any)  => {\n            if (!this.hasRequire(bundleItem.source.slice(node.start, node.end))) {\n                return;\n            }\n            this.walk.base[node.type](node, state, c);\n            if (isRequire(node) && node.arguments.length > 0) {\n                if (node.arguments[0].type === \"Literal\") {\n                    if (!lodash.isString(node.arguments[0].value)) {\n                        this.log.error(\"Unexpected literal value: %s%sRequired by: %s\",\n                            node.arguments[0].value, os.EOL, bundleItem.filename);\n                    }\n                    moduleNames.push(node.arguments[0].value);\n                }\n                else {\n                    expressions.push(node.arguments[0]);\n                }\n            }\n        };\n\n        if (bundleItem.ast.body) {\n            this.walk.recursive(bundleItem.ast, null, {\n                Expression: visitNode,\n                Statement: visitNode\n            });\n        }\n\n        this.addDynamicDependencies(expressions, bundleItem, (dynamicDependencies) => {\n            onDependenciesCollected(moduleNames.concat(dynamicDependencies));\n        });\n    }\n\n    private collectAmbientModules(queue: Queued[]): string[] {\n\n        let ambientModuleNames: string[] = [];\n\n        queue.forEach((queued) => {\n            if (queued.emitOutput.ambientModuleNames) {\n                ambientModuleNames.push(...queued.emitOutput.ambientModuleNames);\n            }\n        });\n\n        return ambientModuleNames;\n    }\n\n    private addBundleItem(queued: Queued, resolvedModule: any, moduleName: string, ambientModuleNames: string[]) {\n        if (ambientModuleNames.indexOf(moduleName) === -1) {\n            queued.item.dependencies.push(\n                new BundleItem(moduleName, resolvedModule && resolvedModule.resolvedFileName)\n            );\n        }\n    }\n\n    private findUnresolvedTsRequires(emitOutput: EmitOutput): BundleItem[] {\n\n        let dependencies: BundleItem[] = [];\n\n        if (emitOutput.isDeclarationFile) {\n            return dependencies;\n        }\n\n        let visitNode = (node: ts.Node) => {\n\n            if (node.kind === ts.SyntaxKind.CallExpression) {\n\n                let ce = (<ts.CallExpression> node);\n\n                let expression = ce.expression ?\n                    (<ts.LiteralExpression> ce.expression) :\n                    undefined;\n\n                let argument = ce.arguments && ce.arguments.length ?\n                    (<ts.LiteralExpression> ce.arguments[0]) :\n                    undefined;\n\n                if (expression && expression.text === \"require\" &&\n                    argument && typeof argument.text === \"string\") {\n                    dependencies.push(new BundleItem(argument.text));\n                }\n            }\n\n            ts.forEachChild(node, visitNode);\n        };\n\n        visitNode(emitOutput.sourceFile);\n\n        return dependencies;\n    }\n\n    private addDynamicDependencies(expressions: any[],\n                                   bundleItem: BundleItem,\n                                   onDynamicDependenciesAdded: { (dynamicDependencies: string[]): void }) {\n\n        let dynamicDependencies: string[] = [];\n\n        if (expressions.length === 0) {\n            process.nextTick(() => {\n                onDynamicDependenciesAdded(dynamicDependencies);\n            });\n            return;\n        }\n\n        async.each(expressions, (expression, onExpressionResolved) => {\n\n            let dynamicModuleName = this.parseDynamicRequire(expression);\n            let directory = path.dirname(bundleItem.filename);\n            let pattern: string;\n\n            if (dynamicModuleName && dynamicModuleName !== \"*\") {\n                if (new BundleItem(dynamicModuleName).isNpmModule()) {\n                    dynamicDependencies.push(dynamicModuleName);\n                    onExpressionResolved();\n                }\n                else {\n                    pattern = path.join(directory, dynamicModuleName);\n                    glob(pattern, (globError, matches) => {\n                        if (globError) {\n                            throw globError;\n                        }\n                        async.each(matches, (match, onMatchResolved) => {\n                            fs.stat(match, (statError, stats) => {\n                                if (statError) {\n                                    throw statError;\n                                }\n                                if (stats.isFile()) {\n                                    this.log.debug(\"Dynamic require: \\nexpression: [%s]\" +\n                                                  \"\\nfilename: %s\\nrequired by %s\\nglob: %s\",\n                                                  JSON.stringify(expression, undefined, 3),\n                                                  match, bundleItem.filename, pattern);\n                                    dynamicDependencies.push(\"./\" + path.relative(directory, match));\n                                }\n                                onMatchResolved();\n                            });\n                        }, onExpressionResolved);\n                    });\n                }\n            }\n            else {\n                onExpressionResolved();\n            }\n        }, () => {\n            onDynamicDependenciesAdded(dynamicDependencies);\n        });\n    }\n\n    private parseDynamicRequire(expression: any): string {\n\n        let visitNode = (node: any): string => {\n            switch (node.type) {\n                case \"BinaryExpression\":\n                    if (node.operator === \"+\") {\n                        return visitNode(node.left) + visitNode(node.right);\n                    }\n                    break;\n                case \"ExpressionStatement\":\n                    return visitNode(node.expression);\n                case \"Literal\":\n                    return node.value + \"\";\n                case \"Identifier\":\n                    return \"*\";\n                default:\n                    return \"\";\n            }\n        };\n\n        return visitNode(expression);\n    }\n\n    private validateCase(queue: Queued[]) {\n\n        let files = queue.map((q) => {\n            return q.file.originalPath;\n        });\n\n        let fileslower = queue.map((q) => {\n            return q.file.originalPath.toLowerCase();\n        });\n\n        queue.forEach((queued) => {\n            if (queued.item.dependencies) {\n                queued.item.dependencies.forEach((dependency) => {\n                    if (dependency.filename && files.indexOf(dependency.filename) === -1) {\n                        let lowerIndex = fileslower.indexOf(dependency.filename.toLowerCase());\n                        if (lowerIndex !== -1) {\n\n                            let result = diff.diffChars(files[lowerIndex], dependency.filename);\n                            let arrows = \"\";\n                            result.forEach((part) => {\n                                if (part.added) {\n                                    arrows += \"^\";\n                                }\n                                else if (!part.removed){\n                                    arrows += pad(\"\", part.count);\n                                }\n                            });\n\n                            throw new Error(\"Uppercase/lowercase mismatch importing \" +\n                                dependency.moduleName + \" from \" + queued.file.originalPath +\n                                \":\" + os.EOL + os.EOL +\n                                \"filename:    \" + files[lowerIndex] + os.EOL +\n                                \"module name: \" + dependency.filename + os.EOL +\n                                \"             \" + arrows + os.EOL);\n                        }\n                    }\n                });\n            }\n        });\n    }\n}\n"]}