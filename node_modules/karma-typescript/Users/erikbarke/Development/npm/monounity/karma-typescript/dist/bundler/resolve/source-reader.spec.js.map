{"version":3,"sources":["../src/bundler/resolve/source-reader.spec.ts"],"names":[],"mappings":"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","file":"../../../../../../../../../dist/bundler/resolve/source-reader.spec.js","sourcesContent":["import * as log4js from \"log4js\";\nimport * as mock from \"mock-require\";\nimport * as os from \"os\";\nimport * as test from \"tape\";\n\nlet readFileCallback = [undefined, new Buffer(\"\")];\n\nmock(\"fs\", {\n    readFile: (filename: string, callback: Function) => {\n        filename = filename;\n        return callback(...readFileCallback);\n    }\n});\n\nimport { ConfigOptions } from \"karma\";\n\nimport { KarmaTypescriptConfig } from \"../../api/configuration\";\nimport { Configuration } from \"../../shared/configuration\";\nimport { Project } from \"../../shared/project\";\nimport { BundleItem } from \"../bundle-item\";\nimport {Â Transformer } from \"../transformer\";\nimport { SourceReader } from \"./source-reader\";\n\nlet configuration = new Configuration({});\nlet project = new Project(configuration, log4js.getLogger(\"project\"));\nlet transformer = new Transformer(configuration, project);\nlet sourceReader = new SourceReader(configuration, log4js.getLogger(\"sourceReader\"), transformer);\n\nlet karmaTypescriptConfig: KarmaTypescriptConfig = {\n    bundlerOptions: {\n        ignore: [\"ignored\"],\n        noParse: [\"noparse\"]\n    }\n};\n\nlet karma: ConfigOptions = {};\n(<any> karma).karmaTypescriptConfig = karmaTypescriptConfig;\n\nconfiguration.initialize(karma);\n\ntest(\"source-reader should return an empty object literal for ignored modules\", (t) => {\n\n    t.plan(1);\n\n    let bundleItem = new BundleItem(\"ignored\", \"ignored.js\");\n\n    sourceReader.read(bundleItem, () => {\n        t.equal(bundleItem.source, \"module.exports={};\");\n    });\n});\n\ntest(\"source-reader should read source for module\", (t) => {\n\n    t.plan(1);\n\n    readFileCallback = [undefined, new Buffer(\"var x;\")];\n    let bundleItem = new BundleItem(\"dummy\", \"dummy.js\");\n\n    sourceReader.read(bundleItem, () => {\n        t.equal(bundleItem.source, \"var x;\");\n    });\n});\n\ntest(\"source-reader should create an AST\", (t) => {\n\n    t.plan(1);\n\n    let bundleItem = new BundleItem(\"dummy\", \"dummy.js\");\n\n    sourceReader.read(bundleItem, () => {\n        t.notEqual(bundleItem.ast.body, undefined);\n    });\n});\n\ntest(\"source-reader should create an empty dummy AST for non-script files (css, JSON...)\", (t) => {\n\n    t.plan(1);\n\n    let bundleItem = new BundleItem(\"style\", \"style.css\");\n\n    sourceReader.read(bundleItem, () => {\n        t.deepEqual(bundleItem.ast, {\n            body: undefined,\n            sourceType: \"script\",\n            type: \"Program\"\n        });\n    });\n});\n\ntest(\"source-reader should create an empty dummy AST for modules specified in the bundler option 'noParse'\", (t) => {\n\n    t.plan(1);\n\n    let bundleItem = new BundleItem(\"noparse\", \"noparse.js\");\n\n    sourceReader.read(bundleItem, () => {\n        t.deepEqual(bundleItem.ast, {\n            body: undefined,\n            sourceType: \"script\",\n            type: \"Program\"\n        });\n    });\n});\n\ntest(\"source-reader should prepend JSON source with 'module.exports ='\", (t) => {\n\n    t.plan(1);\n\n    readFileCallback = [undefined, new Buffer(JSON.stringify([1, 2, 3, \"a\", \"b\", \"c\"]))];\n    let bundleItem = new BundleItem(\"json\", \"json.json\");\n\n    sourceReader.read(bundleItem, () => {\n        t.equal(bundleItem.source, os.EOL + \"module.exports = [1,2,3,\\\"a\\\",\\\"b\\\",\\\"c\\\"];\");\n    });\n});\n\ntest(\"source-reader should prepend stylesheet source (original CSS) with 'module.exports ='\", (t) => {\n\n    t.plan(1);\n\n    readFileCallback = [undefined, new Buffer(\".color { color: red; }\")];\n    let bundleItem = new BundleItem(\"style\", \"style.css\");\n\n    sourceReader.read(bundleItem, () => {\n        t.equal(bundleItem.source, os.EOL + \"module.exports = \\\".color { color: red; }\\\";\");\n    });\n});\n\ntest(\"source-reader should prepend transformed stylesheet source (now JSON) with 'module.exports ='\", (t) => {\n\n    t.plan(1);\n\n    readFileCallback = [undefined, new Buffer(JSON.stringify({ color: \"_color_xkpkl_5\" }))];\n    let bundleItem = new BundleItem(\"transformed\", \"transformed.css\");\n\n    sourceReader.read(bundleItem, () => {\n        t.equal(bundleItem.source, os.EOL + \"module.exports = {\\\"color\\\":\\\"_color_xkpkl_5\\\"};\");\n    });\n});\n\ntest(\"source-reader should not prepend redundant 'module.exports ='\", (t) => {\n\n    t.plan(1);\n\n    readFileCallback = [undefined, new Buffer(\"module.exports = '';\")];\n    let bundleItem = new BundleItem(\"redundant\", \"redundant.css\");\n\n    sourceReader.read(bundleItem, () => {\n        t.equal(bundleItem.source, \"module.exports = '';\");\n    });\n});\n\ntest(\"source-reader should prepend 'module.exports =' to valid javascript with non-script extension, css\", (t) => {\n\n    t.plan(1);\n\n    readFileCallback = [undefined, new Buffer(\"{ color: '_color_xkpkl_5'; }\")];\n    let bundleItem = new BundleItem(\"valid-js\", \"valid-js.css\");\n\n    sourceReader.read(bundleItem, () => {\n        t.equal(bundleItem.source, os.EOL + \"module.exports = \\\"{ color: \\'_color_xkpkl_5\\'; }\\\";\");\n    });\n});\n\ntest(\"source-reader should prepend 'module.exports =' to valid javascript with non-script extension, txt\", (t) => {\n\n    t.plan(1);\n\n    readFileCallback = [undefined, new Buffer(\"(function() {return {foo: 'baz',bork: true}})();\")];\n    let bundleItem = new BundleItem(\"valid-js\", \"valid-js.txt\");\n\n    sourceReader.read(bundleItem, () => {\n        t.equal(bundleItem.source, os.EOL + \"module.exports = \\\"(function() {return {foo: \\'baz\\',bork: true}})();\\\";\");\n    });\n});\n"]}